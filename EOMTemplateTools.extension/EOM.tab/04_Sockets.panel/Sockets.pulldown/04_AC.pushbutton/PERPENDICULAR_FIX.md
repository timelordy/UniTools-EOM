# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û - –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ã—Ö —Å—Ç–µ–Ω–∞—Ö

**–î–∞—Ç–∞**: 2026-01-09 12:00
**–ü—Ä–æ–±–ª–µ–º–∞**: –†–æ–∑–µ—Ç–∫–∏ —Ä–∞–∑–º–µ—â–∞–ª–∏—Å—å –ù–ê —Ñ–∞—Å–∞–¥–µ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ã—Ö —Å—Ç–µ–Ω
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Å—Ç–µ–Ω

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ù–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö –±—ã–ª–æ –≤–∏–¥–Ω–æ:
1. ‚ùå –†–æ–∑–µ—Ç–∫–∏ –Ω–∞ –≤–Ω–µ—à–Ω–µ–π —Å—Ç–µ–Ω–µ (—Ñ–∞—Å–∞–¥–µ –∑–¥–∞–Ω–∏—è)
2. ‚ùå –°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç –∫–æ—Ä–∑–∏–Ω (–¥–æ 8-10 –º–µ—Ç—Ä–æ–≤!)
3. ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è

### –ü—Ä–∏—á–∏–Ω–∞:
–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–∏—Ä–∞–ª —Å—Ç–µ–Ω—ã **–ë–õ–ò–ñ–ê–ô–®–ò–ï** –∫ –∫–æ—Ä–∑–∏–Ω–µ, –∞ —ç—Ç–æ —Ñ–∞—Å–∞–¥–Ω–∞—è —Å—Ç–µ–Ω–∞!

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –£–º–µ–Ω—å—à–µ–Ω—ã –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –≤ config:

**–ë–´–õ–û:**
```json
{
  "ac_room_hard_max_dist_mm": 8000,      // 8 –º–µ—Ç—Ä–æ–≤!
  "ac_wall_search_max_dist_mm": 10000,   // 10 –º–µ—Ç—Ä–æ–≤!!
  "ac_allow_facade_wall_last_resort": true
}
```

**–°–¢–ê–õ–û:**
```json
{
  "ac_room_hard_max_dist_mm": 3000,      // 3 –º–µ—Ç—Ä–∞
  "ac_wall_search_max_dist_mm": 2500,    // 2.5 –º–µ—Ç—Ä–∞
  "ac_validate_basket_max_dist_mm": 2000, // 2 –º–µ—Ç—Ä–∞
  "ac_allow_facade_wall_last_resort": false,  // –ù–ï —Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ñ–∞—Å–∞–¥
  "ac_force_perpendicular_wall": true,    // –¢–û–õ–¨–ö–û –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ã–µ
  "ac_perpendicular_tolerance": 0.3       // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
}
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ—Å—Ç–∏:

```python
def _is_wall_perpendicular_to_basket(wall_curve, pt_basket, room_center, tolerance=0.3):
    """Check if wall is perpendicular to direction from basket to room center.

    Returns True if wall is perpendicular (good for AC socket placement).
    tolerance: dot product threshold (0.3 means ~73 degrees, stricter than 45)
    """
    # Direction from basket to room center
    basket_to_room = (room_center - pt_basket).Normalize()

    # Wall direction
    wall_dir = (wall_end - wall_start).Normalize()

    # Check perpendicularity: dot product should be close to 0
    dot = abs(wall_dir.DotProduct(basket_to_room))
    return dot <= tolerance  # True if perpendicular
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ç–µ–Ω:

#### –í —É–≥–ª–∞—Ö (Corner candidates):
```python
if wall_side and isinstance(wall_side, DB.Wall):
    # Check perpendicularity to basket direction
    is_perp = _is_wall_perpendicular_to_basket(
        wall.LocationCurve, pt_basket, room_center, tolerance=0.3
    )

    # Skip walls that are NOT perpendicular (parallel to facade)
    if not is_perp:
        continue  # ‚ùå SKIP FACADE WALLS

    wall_any = wall_side
    if not _is_exterior_wall(wall_side):
        wall_int = wall_side  # ‚úÖ USE PERPENDICULAR WALL
```

#### –í –ø—Ä–æ–µ–∫—Ü–∏—è—Ö (Projection candidates):
```python
# Check perpendicularity - skip walls parallel to basket direction
if room_center:
    is_perp = _is_wall_perpendicular_to_basket(
        wall_curve, pt_basket, room_center, tolerance=0.3
    )
    if not is_perp:
        continue  # ‚ùå SKIP PARALLEL WALLS
```

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
```
–ö–æ—Ä–∑–∏–Ω–∞ (–°–ù–ê–†–£–ñ–ò)
      ‚Üì
   [–§–∞—Å–∞–¥]  ‚Üê —Ä–æ–∑–µ—Ç–∫–∞ –∑–¥–µ—Å—å (–ù–ê –§–ê–°–ê–î–ï!) ‚ùå
      |
  –ü–æ–º–µ—â–µ–Ω–∏–µ
```

### –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–ü–†–ê–í–ò–õ–¨–ù–û):
```
–ö–æ—Ä–∑–∏–Ω–∞ (–°–ù–ê–†–£–ñ–ò)
      ‚Üì
   [–§–∞—Å–∞–¥]  ‚Üê —Å—Ç–µ–Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è ‚úÖ
      |
  –ü–æ–º–µ—â–µ–Ω–∏–µ
  |       |
  |‚Üê—Ä–æ–∑–µ—Ç–∫–∞ (–Ω–∞ –ü–ï–†–ü–ï–ù–î–ò–ö–£–õ–Ø–†–ù–û–ô —Å—Ç–µ–Ω–µ) ‚úÖ
  |       |
```

### –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ—Å—Ç–∏:**
- –í–µ–∫—Ç–æ—Ä: –∫–æ—Ä–∑–∏–Ω–∞ ‚Üí —Ü–µ–Ω—Ç—Ä –ø–æ–º–µ—â–µ–Ω–∏—è
- –í–µ–∫—Ç–æ—Ä: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–Ω—ã
- –°–∫–∞–ª—è—Ä–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (dot product) ‚â§ 0.3
- 0.3 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —É–≥–ª—É ~73¬∞ (—Å—Ç—Ä–æ–∂–µ —á–µ–º 45¬∞)

**–ü—Ä–∏–º–µ—Ä:**
- –§–∞—Å–∞–¥ –ø–∞—Ä–∞–ª–ª–µ–ª–µ–Ω –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫ –∫–æ—Ä–∑–∏–Ω–µ ‚Üí dot ‚âà 1.0 ‚Üí ‚ùå SKIP
- –ë–æ–∫–æ–≤–∞—è —Å—Ç–µ–Ω–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∞ ‚Üí dot ‚âà 0.0 ‚Üí ‚úÖ USE

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ | –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|----------|-----------------|----------------|-----------|
| `ac_room_hard_max_dist_mm` | 8000 –º–º | 3000 –º–º | -62.5% |
| `ac_wall_search_max_dist_mm` | 10000 –º–º | 2500 –º–º | -75% |
| `ac_validate_basket_max_dist_mm` | 2500 –º–º | 2000 –º–º | -20% |
| `ac_allow_facade_wall_last_resort` | true | false | –ó–∞–ø—Ä–µ—â–µ–Ω–æ |
| `ac_force_perpendicular_wall` | - | true | –ù–æ–≤—ã–π |
| `ac_perpendicular_tolerance` | - | 0.3 | –ù–æ–≤—ã–π |
| `ac_perp_dot_strict` | 0.35 | 0.15 | –°—Ç—Ä–æ–∂–µ |
| `ac_perp_dot_max` | 0.8 | 0.5 | –°—Ç—Ä–æ–∂–µ |

## üß™ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

### ‚úÖ –†–æ–∑–µ—Ç–∫–∏ –±—É–¥—É—Ç:
1. **–í–ù–£–¢–†–ò** –ø–æ–º–µ—â–µ–Ω–∏—è (–Ω–µ –Ω–∞ —Ñ–∞—Å–∞–¥–µ)
2. **–ù–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ–π —Å—Ç–µ–Ω–µ** (–±–æ–∫–æ–≤–æ–π, –∞ –Ω–µ —Ñ–∞—Å–∞–¥–Ω–æ–π)
3. **–í —É–≥–ª—É** –±–ª–∏–∂–∞–π—à–µ–º –∫ –∫–æ—Ä–∑–∏–Ω–µ
4. **–ù–∞ –≤—ã—Å–æ—Ç–µ 300 –º–º** –æ—Ç –ø–æ—Ç–æ–ª–∫–∞
5. **–í 200 –º–º** –æ—Ç —É–≥–ª–∞
6. **–ù–µ –¥–∞–ª—å—à–µ 2 –º–µ—Ç—Ä–æ–≤** –æ—Ç –∫–æ—Ä–∑–∏–Ω—ã

### ‚ùå –†–æ–∑–µ—Ç–∫–∏ –ù–ï –±—É–¥—É—Ç:
1. –ù–∞ —Ñ–∞—Å–∞–¥–µ –∑–¥–∞–Ω–∏—è
2. –ù–∞ —Å—Ç–µ–Ω–∞—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ñ–∞—Å–∞–¥—É
3. –°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç –∫–æ—Ä–∑–∏–Ω (>3 –º–µ—Ç—Ä–æ–≤)
4. –ù–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å—Ç–µ–Ω–∞—Ö

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### –í –ø–ª–∞–Ω–µ:
```
–ü–ª–∞–Ω —ç—Ç–∞–∂–∞ (–≤–∏–¥ —Å–≤–µ—Ä—Ö—É):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–æ–º–µ—â–µ–Ω–∏–µ     ‚îÇ
‚îÇ                 ‚îÇ  –ö–æ—Ä–∑–∏–Ω–∞ (–Ω–∞ –±–∞–ª–∫–æ–Ω–µ)
‚îÇ  ‚óè‚Üê —Ä–æ–∑–µ—Ç–∫–∞   ‚ïë ‚óâ
‚îÇ     (–≤ —É–≥–ª—É)    ‚ïë
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   (—Ñ–∞—Å–∞–¥)

‚óè - —Ä–æ–∑–µ—Ç–∫–∞ –ù–ê –ë–û–ö–û–í–û–ô –°–¢–ï–ù–ï ‚úÖ
‚óâ - –∫–æ—Ä–∑–∏–Ω–∞ –°–ù–ê–†–£–ñ–ò
‚ïë - —Ñ–∞—Å–∞–¥–Ω–∞—è —Å—Ç–µ–Ω–∞ (–ë–ï–ó —Ä–æ–∑–µ—Ç–∫–∏) ‚úÖ
```

### –í 3D:
- –†–æ–∑–µ—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –í–ù–£–¢–†–ò –Ω–∞ –±–æ–∫–æ–≤–æ–π —Å—Ç–µ–Ω–µ
- –ù–ï –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ —Ñ–∞—Å–∞–¥–µ

## üìù –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤

### `rules.default.json`:
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω—ã –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
- ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω fallback –Ω–∞ —Ñ–∞—Å–∞–¥
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–æ—Å—Ç–∏

### `script.py`:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_is_wall_perpendicular_to_basket()`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ room_center
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –≤ corner candidates
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –≤ projection candidates

---

**–°—Ç–∞—Ç—É—Å**: üü¢ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ä–æ–∑–µ—Ç–∫–∏ —Ç–µ–ø–µ—Ä—å:
1. –ù–ï –Ω–∞ —Ñ–∞—Å–∞–¥–µ
2. –ù–∞ –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω—ã—Ö —Å—Ç–µ–Ω–∞—Ö
3. –ë–ª–∏–∑–∫–æ –∫ –∫–æ—Ä–∑–∏–Ω–∞–º
